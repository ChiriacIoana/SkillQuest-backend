generator client {
  provider = "prisma-client-js"
  engineType    = "node-api"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgres"
   url      = env("DATABASE_URL")
}

model User {
  username        String            @unique
  password        String
  userId          Int               @id @default(autoincrement())
  completedQuests Int               @default(0)
  currentXP       Int               @default(0)
  level           Int               @default(1)
  nextLevelXP     Int               @default(500)
  streak          Int               @default(0)
  achievements    UserAchievement[]
  userQuests      UserQuest[]
  coderTypeId     BigInt?
  coderType       UserType? @relation(name: "UserCoderType", fields: [coderTypeId], references: [id])
}

model Quest {
  questId     Int         @id @default(autoincrement())
  xp          Int
  isActive    Boolean     @default(true)
  questName   String
  description String?
  category    String      @default("Calculus")
  difficulty  String      @default("Intermediate")
  questionIds Int[]       @default([])
  userQuests  UserQuest[]
}

model UserQuest {
  id          Int       @id @default(autoincrement())
  userId      Int
  questId     Int
  completed   Boolean   @default(false)
  completedAt DateTime?
  quest       Quest     @relation(fields: [questId], references: [questId])
  user        User      @relation(fields: [userId], references: [userId])

  @@unique([userId, questId], name: "userId_questId")
}

model QuizQuestion {
  id           Int      @id @default(autoincrement())
  externalId   String?  @unique
  source       String
  category     String
  difficulty   String?
  question     String
  answersJson  String
  correctIndex Int?
  xp           Int      @default(50)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Achievement {
  id               Int               @id @default(autoincrement())
  name             String
  description      String
  icon             String
  xpRequired       Int?
  questsRequired   Int?
  category         String
  rarity           String            @default("common")
  createdAt        DateTime          @default(now())
  userAchievements UserAchievement[]
}

model UserAchievement {
  id            Int         @id @default(autoincrement())
  userId        Int
  achievementId Int
  unlockedAt    DateTime    @default(now())
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model UserType {
  id          BigInt   @id @default(autoincrement())
  name        String   @default("")
  min_xp      Decimal? @db.Decimal
  max_xp      Decimal? @db.Decimal
  min_quizzes Decimal? @db.Decimal
  description String?

  users       User[]   @relation("UserCoderType")
}
